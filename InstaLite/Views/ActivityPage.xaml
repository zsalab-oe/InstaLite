<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:InstaLite.ViewModels"
             xmlns:models="clr-namespace:InstaLite.Models"
             x:Class="InstaLite.Views.ActivityPage"
             Title="ActivityPage">
    <ContentPage.BindingContext>
        <vm:ActivityPageViewModel />
    </ContentPage.BindingContext>

    <ScrollView>
        <VerticalStackLayout Padding="16" Spacing="16">
            <!-- Form Card -->
            <Frame Padding="16" HasShadow="True" CornerRadius="12">
                <VerticalStackLayout Spacing="12">
                    <Label Text="Add Activity" FontAttributes="Bold" FontSize="18" />

                    <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto" ColumnSpacing="12" RowSpacing="10">
                        <!-- Type -->
                        <Label Grid.Row="0" Grid.Column="0" Text="Type" VerticalTextAlignment="Center"/>
                        <Picker Grid.Row="0" Grid.Column="1" ItemsSource="{Binding ActivityTypes}" SelectedItem="{Binding SelectedType}"/>

                        <!-- Title -->
                        <Label Grid.Row="1" Grid.Column="0" Text="Title" VerticalTextAlignment="Center"/>
                        <Entry Grid.Row="1" Grid.Column="1" Text="{Binding Title}" Placeholder="Morning Run"/>

                        <!-- Start local date/time -->
                        <Label Grid.Row="2" Grid.Column="0" Text="Date" VerticalTextAlignment="Center"/>
                        <DatePicker Grid.Row="2" Grid.Column="1" Date="{Binding StartDate}"/>

                        <Label Grid.Row="3" Grid.Column="0" Text="Time" VerticalTextAlignment="Center"/>
                        <TimePicker Grid.Row="3" Grid.Column="1" Time="{Binding StartTime}"/>

                        <!-- Duration in minutes -->
                        <Label Grid.Row="4" Grid.Column="0" Text="Duration (min)" VerticalTextAlignment="Center"/>
                        <Entry Grid.Row="4" Grid.Column="1" Keyboard="Numeric" Text="{Binding DurationMinutes}" Placeholder="30"/>

                        <!-- Distance -->
                        <Label Grid.Row="5" Grid.Column="0" Text="Distance (km)" VerticalTextAlignment="Center"/>
                        <Entry Grid.Row="5" Grid.Column="1" Keyboard="Numeric" Text="{Binding DistanceKm}" Placeholder="e.g. 5.2"/>

                        <!-- Calories -->
                        <Label Grid.Row="6" Grid.Column="0" Text="Calories" VerticalTextAlignment="Center"/>
                        <Entry Grid.Row="6" Grid.Column="1" Keyboard="Numeric" Text="{Binding Calories}" Placeholder="e.g. 320"/>

                        <!-- Effort RPE -->
                        <Label Grid.Row="7" Grid.Column="0" Text="Effort (RPE)" VerticalTextAlignment="Center"/>
                        <Grid Grid.Row="7" Grid.Column="1" ColumnDefinitions="Auto,*" ColumnSpacing="8">
                            <Label Grid.Column="0" Text="{Binding EffortRpe}"/>
                            <Slider Grid.Column="1" Minimum="1" Maximum="10" Value="{Binding EffortRpe}"/>
                        </Grid>

                        <!-- Public toggle -->
                        <Label Grid.Row="8" Grid.Column="0" Text="Public" VerticalTextAlignment="Center"/>
                        <Switch Grid.Row="8" Grid.Column="1" IsToggled="{Binding IsPublic}"/>
                    </Grid>

                    <Label Text="Notes"/>
                    <Editor HeightRequest="80" Text="{Binding Notes}" Placeholder="How did it feel?"/>

                    <Button Text="Add Activity" Command="{Binding AddCommand}"/>
                </VerticalStackLayout>
            </Frame>

            <Label Text="Your Activities" FontAttributes="Bold" FontSize="18"/>

            <CollectionView ItemsSource="{Binding Activities}">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame Padding="12" Margin="0,0,0,12" CornerRadius="10">
                            <VerticalStackLayout Spacing="6">
                                <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto">
                                    <Label Grid.Row="0" Grid.Column="0" Text="{Binding Title}" FontAttributes="Bold" />
                                    <Label Grid.Row="0" Grid.Column="1" Text="{Binding Type}"/>
                                    <Label Grid.Row="1" Grid.Column="0" Text="{Binding StartLocal, StringFormat='{}{0:yyyy-MM-dd HH:mm}'}"/>
                                    <Label Grid.Row="1" Grid.Column="1" HorizontalTextAlignment="End"
                                           Text="{Binding Duration, StringFormat='{}{0:hh\\:mm}'}" />
                                </Grid>
                                <Label Text="{Binding Path=., Converter={StaticResource ActivitySummaryConverter}}" IsVisible="False"/>
                                <HorizontalStackLayout Spacing="12">
                                    <Label Text="{Binding DistanceKm, StringFormat='{}{0:0.##} km'}" IsVisible="{Binding DistanceKm, Converter={StaticResource NullToBoolConverter}}"/>
                                    <Label Text="{Binding Calories, StringFormat='{}{0} kcal'}" IsVisible="{Binding Calories, Converter={StaticResource NullToBoolConverter}}"/>
                                    <Label Text="RPE {Binding EffortRpe}" IsVisible="{Binding EffortRpe, Converter={StaticResource NullToBoolConverter}}"/>
                                </HorizontalStackLayout>
                                <Label Text="{Binding Notes}" LineBreakMode="TailTruncation" MaxLines="3"/>
                            </VerticalStackLayout>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>